# Домашнее задание к занятию «Резервное копирование баз данных» - `Рыхлик Илья Александрович`

---

# Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 

Необходимо описать, какие варианты резервного копирования подходят в случаях: 

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

*Приведите ответ в свободной форме.*

## Решение 1

1. Для решения данной задачи подходит ежедневное полное резервное копирование (Full Backup) Оно позволяет создавать точную копию всей базы данных один раз в сутки.

2. Для решения  обеспечения минимальной потери данных используется инкрементное резервное копирование (Incremental Backup) или логическая запись изменений (Point-in-Time Recovery)

3. Решение данной задачи возможено через механизмы High Availability и репликации

---

# Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

*Приведите ответ в свободной форме.*

## Решение 2

1. 

``` pg_dump ``` - позволяет создавать целостные резервные копии отдельных баз данных, не препятствуя работе с базой данных 

```
pg_dump -U <user_name> -h <hosts> -p <port> -d <database_name> -f <name_file> 
```
Некоторые параметры, которые можно указать:
-U <user_name> — имя пользователя для подключения к базе данных. 
-h <hosts> — имя сервера, на котором работает сервер PostgreSQL. По умолчанию host = PGHOST. 
-p <port> — порт, на который сервер принимает подключения. По умолчанию port = PGPORT. 
-d <database_name> — имя базы данных, к которой нужно создать резервную копию.
-f <name_file> — имя файла, в котором будет сохранена резервная копия. Для форматов, основанных на файле, этот параметр можно опустить — в этом случае используется стандартный вывод. Для формата «каталог» (d) параметр обязателен — он указывает на целевой каталог, который создаётся утилитой и не должен существовать до выполнения команды. 
Некоторые дополнительные параметры:
-F <формат> — формат дампа. В PostgreSQL формат может принимать следующие значения: p (plain) — SQL-скрипт (по умолчанию), c (custom) — архивный формат, d (directory) — формат каталога, t (tar) — формат .tar. 
-a (--data-only) — сохранение только данных. 
-c (--clean) — добавление в скрипт команд DROP (может понадобиться при наличии объектов с одинаковыми именами). 
-C (--create) — добавление в скрипт команд для создания БД и подключения к ней. 
-E <кодировка> — установка определённой кодировки дампа. 
-Z [0..9] (--compress=[0..9]) — выбор уровня сжатия (0 — не сжимать, 9 — максимальный)


``` pg_restore ``` - редназначенная для восстановления баз данных из резервных копий

```
pg_restore <user_name> -h <hosts> -p <port> -d <database_name> -f <name_file> 
```

-U <username> или --username=<username> — указывает имя пользователя PostgreSQL для подключения.
-h <hostname> или --host=<hostname> — указывает имя хоста, на котором работает сервер базы данных. По умолчанию берётся из переменной окружения PGHOST, если она установлена.
-p <port> или --port=<port> — указывает порт для подключения к базе данных. По умолчанию берётся из переменной окружения PGPORT, если она установлена.
-d <dbname> или --dbname=<dbname> — указывает имя базы данных, к которой нужно подключиться и восстановить данные непосредственно в неё. В этом аргументе может задаваться строка подключения — в этом случае параметры в строке подключения переопределяют одноимённые параметры, заданные в командной строке.
-f <filename> или --file=<filename> — указывает имя файла для вывода, содержащего лог процесса восстановления.


2. 

```shell
#!/bin/bash
DATE=$(date +"%Y-%m-%d")
BACKUP_DIR="/backups/postgres"
DB_NAME="mydb"
USER="postgres"
pg_dump -U $USER -F c $DB_NAME > $BACKUP_DIR/db_backup_$DATE.dump
```


---

### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

*Приведите ответ в свободной форме.*

## Решение 3

1. Инкрементное резервное копирование базы данных MySQL можно выполнить с помощиью утилиты mysqlbackup и mysqldump

```
mysqlbackup --user=имя_пользователя --password=пароль \ --incremental --incremental-base=dir:/путь_к_последнему_полному_бэкапу \ --backup-dir= путь_для_сохранения_инкрементного_бэкапа backup
```
--incremental — указывает, что создаётся инкрементная копия.
--incremental-base=dir:/путь_к_последнему_полному_бэкапу — путь к последней полной резервной копии, относительно которой создаётся инкрементный бэкап.
--backup-dir=/путь_для_сохранения_инкрементного_бэкапа — директория, куда будет сохранена инкрементная копия.

```
mysqldump --flush-logs --delete-master-logs --single-transaction --all-databases | gzip > /var/backups/mysql/$(date +%d-%m-%Y_%H-%M-%S)-inc.gz
```
--flush-logs инициализирует запись нового двоичного файла журнала.
--delete-master-logs удаляет старые двоичные файлы журнала. Если используется версия MySQL после 8.0.26, вместо --delete-master-logs следует использовать --delete-source-logs.
--single-transaction нужен, если есть таблицы, использующие движок хранения InnoDB.
--all-databases указывает, что команда создаёт резервную копию всех баз данных.

2. Данные типы задач репликация и резервное копирование — разные технологии, и их преимущества зависят от задач системы

- Высокая доступность — если основной сервер выходит из строя, система может быстро переключиться на реплику, тем самым минимизируется простой и потеря данных.
- Масштабирование — можно распределить нагрузку: одни серверы обрабатывают записи, другие — чтения.
- Резервное копирование в реальном времени — в отличие от классического бэкапа, репликация поддерживает копии постоянно актуальными.
Снижение задержек доступа — реплики могут быть географически ближе к пользователям.

Вывод
репликация не заменяет необходимость регулярного резервного копирования — реплики могут быть подвержены тем же проблемам, что и основной сервер, включая повреждение данных, атаки и ошибки конфигурации. Поэтому сочетание репликации с регулярным резервным копированием обеспечивает более комплексную защиту